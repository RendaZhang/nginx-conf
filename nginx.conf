# v2025-07-13 – Migration to Ubuntu 24.04 LTS
user www-data; # Nginx 运行用户
worker_processes auto;
worker_rlimit_nofile 8192;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log warn;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections  1024; # 每个 worker 进程的最大连接数
    multi_accept on;         # 启用多连接接收
    use epoll;
}

http {
    sendfile on;
    tcp_nopush on;
    types_hash_max_size 2048;
    keepalive_timeout 65;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;

    # ================ 缓存配置 ================
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cloudchat_cache:10m inactive=60m max_size=100m use_temp_path=off;
    proxy_cache_key "$scheme$request_method$host$request_uri$is_args$args";
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_ignore_headers Set-Cookie;  # 防止缓存用户敏感数据
    # ======================================

    # 限流配置：10MB 存储空间，5请求/秒
    limit_req_zone $binary_remote_addr zone=flask_limit:10m rate=5r/s;

    # 优化内存使用
    server_names_hash_bucket_size 64;
    client_body_buffer_size 16K;
    client_header_buffer_size 1k;

    gzip on;
    gzip_comp_level 6;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/x-javascript application/javascript text/xml application/xml application/rss+xml text/javascript image/svg+xml application/vnd.ms-fontobject application/x-font-ttf font/opentype;
    gzip_min_length 1000;
    gzip_proxied no-cache no-store private expired auth;

    # Virtual Host Configs
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

}
